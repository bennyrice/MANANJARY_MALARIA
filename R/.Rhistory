scale_color_viridis_d(option = "turbo") +
scale_y_continuous(breaks = c(5, 2, 0, -2, -5)) +
theme_bw()
dfz %>% filter(!is.na(wfaz)) %>% filter(!is.na(hfaz)) %>%
ggplot(aes(x = wfaz, y = hfaz, color = site_code)) +
geom_point(alpha = 0.7) +
#facet_wrap(vars(time_point)) +
scale_color_viridis_d(option = "turbo") +
scale_y_continuous(breaks = c(5, 2, 0, -2, -5)) +
theme_bw()
#Outliers
dfz.x <- dfz %>% filter(abs(wfhz) >= 5 | abs(wfaz) >= 5 | abs(hfaz) >= 5) %>% filter(time_point != "T01")
dfz.y <- dfz %>% filter(unique_ind_id %in% dfz.x$unique_ind_id) %>% arrange(unique_ind_id, time_point) %>% dplyr::select(site_code:dob, KG, CM, PB, wfhz, wfaz, hfaz, age.yrs.at.sample)
#Using a gam to identify outliers
mod_gam.z = gam(hfaz ~ s(wfaz), data = dfz %>% filter(!is.na(wfaz)) %>% filter(!is.na(hfaz)))
summary(mod_gam.z)
#Some outliers apparent
hist(residuals.gam(mod_gam.z))
#Adding the residual for each observation (using absolute value to look for largest outliers)
dfz.res <- dfz %>% filter(!is.na(wfaz)) %>% filter(!is.na(hfaz)) %>% mutate(abs.residuals.gam = abs(residuals.gam(mod_gam.z)))
dfz.res %>% filter(time_point != "T01") %>%
ggplot(aes(x = age.yrs.at.sample, y = abs.residuals.gam)) +
geom_point(aes(color = abs.residuals.gam), alpha = 0.8) +
geom_smooth() +
scale_color_viridis_c(option = "inferno", end = 0.9) +
theme_bw()
dfx <- dfz.res %>% filter(abs.residuals.gam > 4) %>% filter(time_point != "T01")
dfy <- dfz.res %>% filter(unique_ind_id %in% dfx$unique_ind_id) %>% arrange(unique_ind_id, time_point) %>% dplyr::select(site_code:dob, KG, CM, PB, wfhz, wfaz, hfaz, abs.residuals.gam, age.yrs.at.sample)
mod_gam.wfh = gam(wfhz ~ s(wfaz), data = dfz %>% filter(!is.na(wfhz)) %>% filter(!is.na(wfaz)))
summary(mod_gam.wfh)
#Some outliers apparent
hist(residuals.gam(mod_gam.wfh))
#Adding the residual for each observation (using absolute value to look for largest outliers)
dfz.res2 <- dfz %>% filter(!is.na(wfhz)) %>% filter(!is.na(wfaz)) %>% mutate(abs.residuals.gam = abs(residuals.gam(mod_gam.wfh)))
dfz.res2 %>% filter(time_point != "T01") %>%
ggplot(aes(x = age.yrs.at.sample, y = abs.residuals.gam)) +
geom_point(aes(color = abs.residuals.gam), alpha = 0.8) +
geom_smooth() +
scale_color_viridis_c(option = "inferno", end = 0.9) +
theme_bw()
dfx <- dfz.res2 %>% filter(abs.residuals.gam > 4) %>% filter(time_point != "T01")
dfy <- dfz.res2 %>% filter(unique_ind_id %in% dfx$unique_ind_id) %>% arrange(unique_ind_id, time_point) %>% dplyr::select(site_code:dob, KG, CM, PB, wfhz, wfaz, hfaz, abs.residuals.gam, age.yrs.at.sample)
#Error cases:
#MUAC/PB outside of plausible range
hist(df.primary$PB)
df.primary %>% filter(!is.na(PB)) %>% filter(!is.na(KG)) %>%
ggplot(aes(x = KG, y = PB, color = site_code)) +
geom_point(alpha = 0.7) +
scale_color_viridis_d(option = "turbo") +
theme_bw()
#Error cases:
#PC outside of plausible range
df.primary %>% filter(!is.na(PC)) %>% filter(!is.na(KG)) %>%
ggplot(aes(x = KG, y = PC, color = time_point)) +
geom_point(alpha = 0.7) +
scale_color_viridis_d(option = "cividis", end = 0.95) +
theme_bw()
#Error cases:
#TEMP outside of plausible range
df.primary %>% filter(!is.na(TEMP)) %>%
ggplot(aes(x = TEMP, y = 1, color = TEMP)) +
geom_jitter(alpha = 0.7) +
scale_color_viridis_c(option = "magma") +
ylim(0, 2) +
theme_bw()
#Error cases:
#TEMP outside of plausible range
hist(df.primary$RDT_TIME)
df.primary %>% filter(!is.na(RDT_TIME)) %>%
ggplot(aes(x = RDT_TIME, y = site_code, color = RDT_TIME)) +
geom_jitter(alpha = 0.7) +
scale_color_viridis_c(option = "mako") +
#facet_wrap(vars(time_point)) +
theme_bw()
##############################################################################################################################
write_csv(df.primary, "/Users/blrice/Documents/GitHub/MANANJARY_MALARIA/data/rdt_hb_anthro_data.csv")
library(tidyverse)
library(patchwork)
library(googlesheets4)
library(mgcv)
library(zscorer)
#########################################################################################################
# Read in data
#########################################################################################################
dfi <- readr::read_csv("/Users/blrice/Documents/GitHub/MANANJARY_MALARIA/data/rdt_hb_anthro_data.csv")
df1 <- dfi %>%
#Recoding sex: 1 (male) or 2 (female)
mutate(sex.coded = case_when(sex == "M" ~ 1, sex == "F" ~ 2)) %>%
#Recoding age in days
mutate(age.days = age.yrs.at.sample*365.25)
#Weight-for-height (wfh) z-scores for children with heights between 65 and 120 cm
#(Wasting)
#Severe Acute Malnutrition = SAM: wfhz score <-3
#Moderate Acute Malnutrition = MAM: wfhz score ≥ -3 and < -2 z-score
df1 <- addWGSR(data = df1, sex = "sex.coded", firstPart = "KG", secondPart = "CM", index = "wfh")
df1 <- df1 %>% mutate(wasting.cat = case_when(
wfhz >= -2 ~ "normal",
wfhz <  -2 & wfhz >= -3 ~ "MAM",
wfhz <  -3 ~ "SAM")) %>%
mutate(wasting.cat = factor(wasting.cat, levels = rev(c("normal","MAM","SAM"))))
#Weight-for-age (wfa) z-scores for children aged between zero and 120 months
#(Underweight)
df1 <- addWGSR(data = df1, sex = "sex.coded", firstPart = "KG", secondPart = "age.days", index = "wfa")
df1 <- df1 %>% mutate(underweight.cat = case_when(
wfaz >= -2 ~ "normal",
wfaz <  -2 ~ "underweight")) %>%
mutate(underweight.cat=factor(underweight.cat, levels=rev(c("normal","underweight"))))
#Height-for-age (hfa) z-scores for children aged between 24 and 228 months
#(Stunting)
df1 <- addWGSR(data = df1, sex = "sex.coded", firstPart = "CM", secondPart = "age.days", index = "hfa")
df1 <- df1 %>% mutate(stunting.cat = case_when(
hfaz >= -2 ~ "normal",
hfaz <  -2 ~ "stunting")) %>%
mutate(stunting.cat=factor(stunting.cat, levels=rev(c("normal","stunting"))))
#Test plotting
df1 %>% ggplot(aes(x = time_point, y = wfhz, color = site_code)) +
geom_point() +
geom_boxplot() +
facet_wrap(vars(site_code)) +
theme_bw()
df1 %>% ggplot(aes(x = time_point, y = wfhz, color = wfhz)) +
geom_jitter() +
facet_wrap(vars(site_code)) +
theme_bw()
#########################################################################################################
# 2 # Calculate MAM/SAM via PB/MUAC
#########################################################################################################
# https://www.ncbi.nlm.nih.gov/books/NBK601660/#ch1.s4
#Thresholds: For children 5y and younger
#   Moderate Acute Malnutrition (MAM):  PB/MUAC between 11.5 and 12.5
#   Severe Acute Malnutrition (SAM):    PB/MUAC < 11.5
df1 <- df1 %>% mutate(MUAC.cat = case_when(
age.yrs.at.sample < 6 & PB >  12.5              ~ "normal",
age.yrs.at.sample < 6 & PB >  11.5 & PB <= 12.5 ~ "MAM",
age.yrs.at.sample < 6 & PB <= 11.5              ~ "SAM")) %>%
mutate(MUAC.cat=factor(MUAC.cat, levels=rev(c("normal","MAM","SAM"))))
#########################################################################################################
# 3 # Calculate Anemia Categories
#########################################################################################################
#Applying anemia cut-offs
#Cut-offs used
# (ANE_A1) Newborns <  0.5 y                         = 'NA_Too_young'
# (ANE_B1) Children >= 0.5 y and <= 5 y : Hb  <  7.0 = '1_Severe'
# (ANE_B2) Children >= 0.5 y and <= 5 y : Hb  < 10.0 = '2_Moderate'
# (ANE_B3) Children >= 0.5 y and <= 5 y : Hb  < 11.0 = '3_Mild'
# (ANE_B4) Children >= 0.5 y and <= 5 y : Hb >= 11.0 = '0_Non_anemia'
# (ANE_C1) Children >    5 y and < 12 y : Hb  <  8.0 = '1_Severe'
# (ANE_C2) Children >    5 y and < 12 y : Hb  < 11.0 = '2_Moderate'
# (ANE_C3) Children >    5 y and < 12 y : Hb  < 11.5 = '3_Mild'
# (ANE_C4) Children >    5 y and < 12 y : Hb >= 11.5 = '0_Non_anemia'
# (ANE_D1) Children >=  12 y and < 15 y : Hb  <  8.0 = '1_Severe'
# (ANE_D2) Children >=  12 y and < 15 y : Hb  < 11.0 = '2_Moderate'
# (ANE_D3) Children >=  12 y and < 15 y : Hb  < 12.0 = '3_Mild'
# (ANE_D4) Children >=  12 y and < 15 y : Hb >= 12.0 = '0_Non_anemia'
# (ANE_E1) NP Females >= 15 y           : Hb  <  8.0 = '1_Severe'
# (ANE_E2) NP Females >= 15 y           : Hb  < 11.0 = '2_Moderate'
# (ANE_E3) NP Females >= 15 y           : Hb  < 12.0 = '3_Mild'
# (ANE_E4) NP Females >= 15 y           : Hb >= 12.0 = '0_Non_anemia'
# (ANE_F1) PR Females >= 15 y           : Hb  <  7.0 = '1_Severe'
# (ANE_F2) PR Females >= 15 y           : Hb  < 10.0 = '2_Moderate'
# (ANE_F3) PR Females >= 15 y           : Hb  < 11.0 = '3_Mild'
# (ANE_F4) PR Females >= 15 y           : Hb >= 11.0 = '0_Non_anemia'
# (ANE_G1) Males      >= 15 y           : Hb  <  8.0 = '1_Severe'
# (ANE_G2) Males      >= 15 y           : Hb  < 11.0 = '2_Moderate'
# (ANE_G3) Males      >= 15 y           : Hb  < 13.0 = '3_Mild'
# (ANE_G4) Males      >= 15 y           : Hb >= 13.0 = '0_Non_anemia'
# Using case_when() to filter age, sex, and anemia groups
df1 <- df1 %>%
mutate(anemia.cat = case_when(
age.yrs.at.sample  < 0.5 & !is.na(Hb)                             ~ 'ANE_A1',
age.yrs.at.sample >= 0.5 & age.yrs.at.sample <=  5   & Hb <   7.0 ~ 'ANE_B1',
age.yrs.at.sample >= 0.5 & age.yrs.at.sample <=  5   & Hb <  10.0 ~ 'ANE_B2',
age.yrs.at.sample >= 0.5 & age.yrs.at.sample <=  5   & Hb <  11.0 ~ 'ANE_B3',
age.yrs.at.sample >= 0.5 & age.yrs.at.sample <=  5   & Hb >= 11.0 ~ 'ANE_B4',
age.yrs.at.sample >    5 & age.yrs.at.sample <  12   & Hb <   8.0 ~ 'ANE_C1',
age.yrs.at.sample >    5 & age.yrs.at.sample <  12   & Hb <  11.0 ~ 'ANE_C2',
age.yrs.at.sample >    5 & age.yrs.at.sample <  12   & Hb <  11.5 ~ 'ANE_C3',
age.yrs.at.sample >    5 & age.yrs.at.sample <  12   & Hb >= 11.5 ~ 'ANE_C4',
age.yrs.at.sample >=  12 & age.yrs.at.sample <  15   & Hb <   8.0 ~ 'ANE_D1',
age.yrs.at.sample >=  12 & age.yrs.at.sample <  15   & Hb <  11.0 ~ 'ANE_D2',
age.yrs.at.sample >=  12 & age.yrs.at.sample <  15   & Hb <  12.0 ~ 'ANE_D3',
age.yrs.at.sample >=  12 & age.yrs.at.sample <  15   & Hb >= 12.0 ~ 'ANE_D4',
age.yrs.at.sample >=  15 & sex == 'F' & Hb <   8.0 ~ 'ANE_E1',
age.yrs.at.sample >=  15 & sex == 'F' & Hb <  11.0 ~ 'ANE_E2',
age.yrs.at.sample >=  15 & sex == 'F' & Hb <  12.0 ~ 'ANE_E3',
age.yrs.at.sample >=  15 & sex == 'F' & Hb >= 12.0 ~ 'ANE_E4',
age.yrs.at.sample >=  15 & sex == 'M' & Hb <   8.0 ~ 'ANE_G1',
age.yrs.at.sample >=  15 & sex == 'M' & Hb <  11.0 ~ 'ANE_G2',
age.yrs.at.sample >=  15 & sex == 'M' & Hb <  13.0 ~ 'ANE_G3',
age.yrs.at.sample >=  15 & sex == 'M' & Hb >= 13.0 ~ 'ANE_G4'))
df1 <- df1 %>%
mutate(anemia.result = case_when(
anemia.cat == 'ANE_A1' ~ 'NA_Too_young',
anemia.cat == 'ANE_B1' ~ '1_Severe',
anemia.cat == 'ANE_B2' ~ '2_Moderate',
anemia.cat == 'ANE_B3' ~ '3_Mild',
anemia.cat == 'ANE_B4' ~ '0_Non_anemia',
anemia.cat == 'ANE_C1' ~ '1_Severe',
anemia.cat == 'ANE_C2' ~ '2_Moderate',
anemia.cat == 'ANE_C3' ~ '3_Mild',
anemia.cat == 'ANE_C4' ~ '0_Non_anemia',
anemia.cat == 'ANE_D1' ~ '1_Severe',
anemia.cat == 'ANE_D2' ~ '2_Moderate',
anemia.cat == 'ANE_D3' ~ '3_Mild',
anemia.cat == 'ANE_D4' ~ '0_Non_anemia',
anemia.cat == 'ANE_E1' ~ '1_Severe',
anemia.cat == 'ANE_E2' ~ '2_Moderate',
anemia.cat == 'ANE_E3' ~ '3_Mild',
anemia.cat == 'ANE_E4' ~ '0_Non_anemia',
anemia.cat == 'ANE_G1' ~ '1_Severe',
anemia.cat == 'ANE_G2' ~ '2_Moderate',
anemia.cat == 'ANE_G3' ~ '3_Mild',
anemia.cat == 'ANE_G4' ~ '0_Non_anemia')) %>%
mutate(anemia.result = factor(anemia.result, levels = c('1_Severe','2_Moderate','3_Mild','0_Non_anemia','NA_Too_young')))
write_csv(df.primary, "/Users/blrice/Documents/GitHub/MANANJARY_MALARIA/data/rdt_hb_anthro_data_raw.csv")
write_csv(df.primary, "/Users/blrice/Documents/GitHub/MANANJARY_MALARIA/data/rdt_hb_anthro_data_raw.csv")
#########################################################################################################
# Read in data
#########################################################################################################
dfi <- readr::read_csv("/Users/blrice/Documents/GitHub/MANANJARY_MALARIA/data/raw_data/malaria_nutrition_data/rdt_hb_anthro_data_raw.csv")
#########################################################################################################
# 1 # Calculate z scores
#########################################################################################################
df1 <- dfi %>%
#Recoding sex: 1 (male) or 2 (female)
mutate(sex.coded = case_when(sex == "M" ~ 1, sex == "F" ~ 2)) %>%
#Recoding age in days
mutate(age.days = age.yrs.at.sample*365.25)
#Calculations: wfh, wfa, hfa
#Weight-for-height (wfh) z-scores for children with heights between 65 and 120 cm
#(Wasting)
#Severe Acute Malnutrition = SAM: wfhz score <-3
#Moderate Acute Malnutrition = MAM: wfhz score ≥ -3 and < -2 z-score
df1 <- addWGSR(data = df1, sex = "sex.coded", firstPart = "KG", secondPart = "CM", index = "wfh")
df1 <- df1 %>% mutate(wasting.cat = case_when(
wfhz >= -2 ~ "normal",
wfhz <  -2 & wfhz >= -3 ~ "MAM",
wfhz <  -3 ~ "SAM")) %>%
mutate(wasting.cat = factor(wasting.cat, levels = rev(c("normal","MAM","SAM"))))
#Weight-for-age (wfa) z-scores for children aged between zero and 120 months
#(Underweight)
df1 <- addWGSR(data = df1, sex = "sex.coded", firstPart = "KG", secondPart = "age.days", index = "wfa")
df1 <- df1 %>% mutate(underweight.cat = case_when(
wfaz >= -2 ~ "normal",
wfaz <  -2 ~ "underweight")) %>%
mutate(underweight.cat=factor(underweight.cat, levels=rev(c("normal","underweight"))))
#Height-for-age (hfa) z-scores for children aged between 24 and 228 months
#(Stunting)
df1 <- addWGSR(data = df1, sex = "sex.coded", firstPart = "CM", secondPart = "age.days", index = "hfa")
df1 <- df1 %>% mutate(stunting.cat = case_when(
hfaz >= -2 ~ "normal",
hfaz <  -2 ~ "stunting")) %>%
mutate(stunting.cat=factor(stunting.cat, levels=rev(c("normal","stunting"))))
#Test plotting
df1 %>% ggplot(aes(x = time_point, y = wfhz, color = site_code)) +
geom_point() +
geom_boxplot() +
facet_wrap(vars(site_code)) +
theme_bw()
df1 %>% ggplot(aes(x = time_point, y = wfhz, color = wfhz)) +
geom_jitter() +
facet_wrap(vars(site_code)) +
theme_bw()
#########################################################################################################
# 2 # Calculate MAM/SAM via PB/MUAC
#########################################################################################################
# https://www.ncbi.nlm.nih.gov/books/NBK601660/#ch1.s4
#Thresholds: For children 5y and younger
#   Moderate Acute Malnutrition (MAM):  PB/MUAC between 11.5 and 12.5
#   Severe Acute Malnutrition (SAM):    PB/MUAC < 11.5
df1 <- df1 %>% mutate(MUAC.cat = case_when(
age.yrs.at.sample < 6 & PB >  12.5              ~ "normal",
age.yrs.at.sample < 6 & PB >  11.5 & PB <= 12.5 ~ "MAM",
age.yrs.at.sample < 6 & PB <= 11.5              ~ "SAM")) %>%
mutate(MUAC.cat=factor(MUAC.cat, levels=rev(c("normal","MAM","SAM"))))
#########################################################################################################
# 3 # Calculate Anemia Categories
#########################################################################################################
#Applying anemia cut-offs
#Cut-offs used
# (ANE_A1) Newborns <  0.5 y                         = 'NA_Too_young'
# (ANE_B1) Children >= 0.5 y and <= 5 y : Hb  <  7.0 = '1_Severe'
# (ANE_B2) Children >= 0.5 y and <= 5 y : Hb  < 10.0 = '2_Moderate'
# (ANE_B3) Children >= 0.5 y and <= 5 y : Hb  < 11.0 = '3_Mild'
# (ANE_B4) Children >= 0.5 y and <= 5 y : Hb >= 11.0 = '0_Non_anemia'
# (ANE_C1) Children >    5 y and < 12 y : Hb  <  8.0 = '1_Severe'
# (ANE_C2) Children >    5 y and < 12 y : Hb  < 11.0 = '2_Moderate'
# (ANE_C3) Children >    5 y and < 12 y : Hb  < 11.5 = '3_Mild'
# (ANE_C4) Children >    5 y and < 12 y : Hb >= 11.5 = '0_Non_anemia'
# (ANE_D1) Children >=  12 y and < 15 y : Hb  <  8.0 = '1_Severe'
# (ANE_D2) Children >=  12 y and < 15 y : Hb  < 11.0 = '2_Moderate'
# (ANE_D3) Children >=  12 y and < 15 y : Hb  < 12.0 = '3_Mild'
# (ANE_D4) Children >=  12 y and < 15 y : Hb >= 12.0 = '0_Non_anemia'
# (ANE_E1) NP Females >= 15 y           : Hb  <  8.0 = '1_Severe'
# (ANE_E2) NP Females >= 15 y           : Hb  < 11.0 = '2_Moderate'
# (ANE_E3) NP Females >= 15 y           : Hb  < 12.0 = '3_Mild'
# (ANE_E4) NP Females >= 15 y           : Hb >= 12.0 = '0_Non_anemia'
# (ANE_F1) PR Females >= 15 y           : Hb  <  7.0 = '1_Severe'
# (ANE_F2) PR Females >= 15 y           : Hb  < 10.0 = '2_Moderate'
# (ANE_F3) PR Females >= 15 y           : Hb  < 11.0 = '3_Mild'
# (ANE_F4) PR Females >= 15 y           : Hb >= 11.0 = '0_Non_anemia'
# (ANE_G1) Males      >= 15 y           : Hb  <  8.0 = '1_Severe'
# (ANE_G2) Males      >= 15 y           : Hb  < 11.0 = '2_Moderate'
# (ANE_G3) Males      >= 15 y           : Hb  < 13.0 = '3_Mild'
# (ANE_G4) Males      >= 15 y           : Hb >= 13.0 = '0_Non_anemia'
# Using case_when() to filter age, sex, and anemia groups
df1 <- df1 %>%
mutate(anemia.cat = case_when(
age.yrs.at.sample  < 0.5 & !is.na(Hb)                             ~ 'ANE_A1',
age.yrs.at.sample >= 0.5 & age.yrs.at.sample <=  5   & Hb <   7.0 ~ 'ANE_B1',
age.yrs.at.sample >= 0.5 & age.yrs.at.sample <=  5   & Hb <  10.0 ~ 'ANE_B2',
age.yrs.at.sample >= 0.5 & age.yrs.at.sample <=  5   & Hb <  11.0 ~ 'ANE_B3',
age.yrs.at.sample >= 0.5 & age.yrs.at.sample <=  5   & Hb >= 11.0 ~ 'ANE_B4',
age.yrs.at.sample >    5 & age.yrs.at.sample <  12   & Hb <   8.0 ~ 'ANE_C1',
age.yrs.at.sample >    5 & age.yrs.at.sample <  12   & Hb <  11.0 ~ 'ANE_C2',
age.yrs.at.sample >    5 & age.yrs.at.sample <  12   & Hb <  11.5 ~ 'ANE_C3',
age.yrs.at.sample >    5 & age.yrs.at.sample <  12   & Hb >= 11.5 ~ 'ANE_C4',
age.yrs.at.sample >=  12 & age.yrs.at.sample <  15   & Hb <   8.0 ~ 'ANE_D1',
age.yrs.at.sample >=  12 & age.yrs.at.sample <  15   & Hb <  11.0 ~ 'ANE_D2',
age.yrs.at.sample >=  12 & age.yrs.at.sample <  15   & Hb <  12.0 ~ 'ANE_D3',
age.yrs.at.sample >=  12 & age.yrs.at.sample <  15   & Hb >= 12.0 ~ 'ANE_D4',
age.yrs.at.sample >=  15 & sex == 'F' & Hb <   8.0 ~ 'ANE_E1',
age.yrs.at.sample >=  15 & sex == 'F' & Hb <  11.0 ~ 'ANE_E2',
age.yrs.at.sample >=  15 & sex == 'F' & Hb <  12.0 ~ 'ANE_E3',
age.yrs.at.sample >=  15 & sex == 'F' & Hb >= 12.0 ~ 'ANE_E4',
age.yrs.at.sample >=  15 & sex == 'M' & Hb <   8.0 ~ 'ANE_G1',
age.yrs.at.sample >=  15 & sex == 'M' & Hb <  11.0 ~ 'ANE_G2',
age.yrs.at.sample >=  15 & sex == 'M' & Hb <  13.0 ~ 'ANE_G3',
age.yrs.at.sample >=  15 & sex == 'M' & Hb >= 13.0 ~ 'ANE_G4'))
df1 <- df1 %>%
mutate(anemia.result = case_when(
anemia.cat == 'ANE_A1' ~ 'NA_Too_young',
anemia.cat == 'ANE_B1' ~ '1_Severe',
anemia.cat == 'ANE_B2' ~ '2_Moderate',
anemia.cat == 'ANE_B3' ~ '3_Mild',
anemia.cat == 'ANE_B4' ~ '0_Non_anemia',
anemia.cat == 'ANE_C1' ~ '1_Severe',
anemia.cat == 'ANE_C2' ~ '2_Moderate',
anemia.cat == 'ANE_C3' ~ '3_Mild',
anemia.cat == 'ANE_C4' ~ '0_Non_anemia',
anemia.cat == 'ANE_D1' ~ '1_Severe',
anemia.cat == 'ANE_D2' ~ '2_Moderate',
anemia.cat == 'ANE_D3' ~ '3_Mild',
anemia.cat == 'ANE_D4' ~ '0_Non_anemia',
anemia.cat == 'ANE_E1' ~ '1_Severe',
anemia.cat == 'ANE_E2' ~ '2_Moderate',
anemia.cat == 'ANE_E3' ~ '3_Mild',
anemia.cat == 'ANE_E4' ~ '0_Non_anemia',
anemia.cat == 'ANE_G1' ~ '1_Severe',
anemia.cat == 'ANE_G2' ~ '2_Moderate',
anemia.cat == 'ANE_G3' ~ '3_Mild',
anemia.cat == 'ANE_G4' ~ '0_Non_anemia')) %>%
mutate(anemia.result = factor(anemia.result, levels = c('1_Severe','2_Moderate','3_Mild','0_Non_anemia','NA_Too_young')))
#Test plotting
df1 %>% filter(!is.na(Hb)) %>% group_by(site_code, anemia.result) %>%
summarize(n = n()) %>%
group_by(site_code) %>%
mutate(prev =  n/sum(n) * 100) %>%
ggplot(aes(x = site_code, y = prev, fill = anemia.result, group = site_code)) +
geom_bar(stat = "identity") +
theme_bw()
df1 %>% filter(!is.na(Hb)) %>%
ggplot(aes(x = site_code, fill = anemia.result)) +
geom_bar(stat = ) +
theme_bw()
#Exporting processed data
write_csv(df1, "/Users/blrice/Documents/GitHub/MANANJARY_MALARIA/data/processed_data/rdt_hb_anthro_data.csv")
library(tidyverse)
library(patchwork)
#read in questionnaire data
dfi <- readxl::read_excel("/Users/blrice/Library/CloudStorage/Dropbox/Lab Projects/2020 Projects/CRS2020/1 DATA/DATA/DATA_QUESTIONNAIRE/T11_Commcare Data Downloads 20230428/2_fanadiadiana/1 Follow Up/MALARIA - FANADIADIANA - Follow Up Questionnaire (created 2023-04-29) 2023-04-29.xlsx")
cols_to_keep <- c("form.ind_data.ind_code", "completed_time",
"form.lohantokontrano.section_03_fanontaniana_mikasika_ny_fanjarian-tsakafo.csi_skip_eating_days",
"form.lohantokontrano.section_03_fanontaniana_mikasika_ny_fanjarian-tsakafo.csi_reduce_meals_days",
"form.lohantokontrano.section_03_fanontaniana_mikasika_ny_fanjarian-tsakafo.csi_hunt_days",
"form.lohantokontrano.section_03_fanontaniana_mikasika_ny_fanjarian-tsakafo.csi_gather_days",
"form.lohantokontrano.section_03_fanontaniana_mikasika_ny_fanjarian-tsakafo.csi_restrict_nonworkers",
"form.lohantokontrano.section_03_fanontaniana_mikasika_ny_fanjarian-tsakafo.csi_restrict_children",
"form.lohantokontrano.section_03_fanontaniana_mikasika_ny_fanjarian-tsakafo.csi_restrict_adults",
"form.lohantokontrano.section_03_fanontaniana_mikasika_ny_fanjarian-tsakafo.csi_limit_portions",
"form.lohantokontrano.section_03_fanontaniana_mikasika_ny_fanjarian-tsakafo.csi_send_beg",
"form.lohantokontrano.section_03_fanontaniana_mikasika_ny_fanjarian-tsakafo.csi_send_to_others",
"form.lohantokontrano.section_03_fanontaniana_mikasika_ny_fanjarian-tsakafo.csi_consume_stock",
"form.lohantokontrano.section_03_fanontaniana_mikasika_ny_fanjarian-tsakafo.csi_harvest_early",
"form.lohantokontrano.section_03_fanontaniana_mikasika_ny_fanjarian-tsakafo.csi_purchase_on_credit",
"form.lohantokontrano.section_03_fanontaniana_mikasika_ny_fanjarian-tsakafo.csi_borrow_food",
"form.lohantokontrano.section_03_fanontaniana_mikasika_ny_fanjarian-tsakafo.csi_less_preferred",
"form.section_03_fanontaniana_mikasika_ny_fanjarian-tsakafo.csi_skip_eating_days",
"form.section_03_fanontaniana_mikasika_ny_fanjarian-tsakafo.csi_reduce_meals_days",
"form.section_03_fanontaniana_mikasika_ny_fanjarian-tsakafo.csi_hunt_days",
"form.section_03_fanontaniana_mikasika_ny_fanjarian-tsakafo.csi_gather_days",
"form.section_03_fanontaniana_mikasika_ny_fanjarian-tsakafo.csi_restrict_nonworkers",
"form.section_03_fanontaniana_mikasika_ny_fanjarian-tsakafo.csi_restrict_children",
"form.section_03_fanontaniana_mikasika_ny_fanjarian-tsakafo.csi_restrict_adults",
"form.section_03_fanontaniana_mikasika_ny_fanjarian-tsakafo.csi_limit_portions",
"form.section_03_fanontaniana_mikasika_ny_fanjarian-tsakafo.csi_send_beg",
"form.section_03_fanontaniana_mikasika_ny_fanjarian-tsakafo.csi_send_to_others",
"form.section_03_fanontaniana_mikasika_ny_fanjarian-tsakafo.csi_consume_stock",
"form.section_03_fanontaniana_mikasika_ny_fanjarian-tsakafo.csi_harvest_early",
"form.section_03_fanontaniana_mikasika_ny_fanjarian-tsakafo.csi_purchase_on_credit",
"form.section_03_fanontaniana_mikasika_ny_fanjarian-tsakafo.csi_borrow_food",
"form.section_03_fanontaniana_mikasika_ny_fanjarian-tsakafo.csi_less_preferred")
df1 <- dfi %>% dplyr::select(all_of(cols_to_keep))
#Cleaning up column names
names(df1) <- sub('form.lohantokontrano.section_03_fanontaniana_mikasika_ny_fanjarian-tsakafo.', 'T02.S.', names(df1))
names(df1) <- sub('form.section_03_fanontaniana_mikasika_ny_fanjarian-tsakafo.', '', names(df1))
View(df1)
df2 <- df1 %>%
rename(unique_ind_id = form.ind_data.ind_code) %>%
#Adding site code
mutate(site_code = substr(unique_ind_id, 1, 2)) %>%
mutate(date = ymd(substr(completed_time, 1, 10))) %>%
dplyr::select(-completed_time) %>%
mutate(time_point = case_when(
date >= ymd("2021-07-21") & date <= ymd("2021-10-19") ~ "T01",
date >= ymd("2021-11-18") & date <= ymd("2021-12-13") ~ "T02",
date >= ymd("2022-01-11") & date <= ymd("2022-03-16") ~ "T03",
date >= ymd("2022-03-31") & date <= ymd("2022-05-06") ~ "T04",
date >= ymd("2022-05-12") & date <= ymd("2022-06-21") ~ "T05",
date >= ymd("2022-07-07") & date <= ymd("2022-08-14") ~ "T06",
date >= ymd("2022-08-24") & date <= ymd("2022-09-17") ~ "T07",
date >= ymd("2022-10-18") & date <= ymd("2022-11-12") ~ "T08",
date >= ymd("2022-11-23") & date <= ymd("2022-12-20") ~ "T09",
date >= ymd("2023-01-27") & date <= ymd("2023-03-06") ~ "T10",
date >= ymd("2023-03-15") & date <= ymd("2023-04-27") ~ "T11")) %>%
#Trashing some rows that were from test survey submissions submitted before/after sampling time points
filter(!is.na(time_point)) %>%
#Converting annoying "---"s from commcare to NAs
mutate(across(T02.S.csi_skip_eating_days:csi_less_preferred, ~na_if(., "---")))
names(df2)
df3 <- df2 %>% mutate(
skip_eating_days    = ifelse(is.na(T02.S.csi_skip_eating_days),    csi_skip_eating_days,    T02.S.csi_skip_eating_days),
reduce_meals_days   = ifelse(is.na(T02.S.csi_reduce_meals_days),   csi_reduce_meals_days,   T02.S.csi_reduce_meals_days),
hunt_days           = ifelse(is.na(T02.S.csi_hunt_days),           csi_hunt_days,           T02.S.csi_hunt_days),
gather_days         = ifelse(is.na(T02.S.csi_gather_days),         csi_gather_days,         T02.S.csi_gather_days),
restrict_nonworkers = ifelse(is.na(T02.S.csi_restrict_nonworkers), csi_restrict_nonworkers, T02.S.csi_restrict_nonworkers),
restrict_children   = ifelse(is.na(T02.S.csi_restrict_children),   csi_restrict_children,   T02.S.csi_restrict_children),
restrict_adults     = ifelse(is.na(T02.S.csi_restrict_adults),     csi_restrict_adults,     T02.S.csi_restrict_adults),
limit_portions      = ifelse(is.na(T02.S.csi_limit_portions),      csi_limit_portions,      T02.S.csi_limit_portions),
send_beg            = ifelse(is.na(T02.S.csi_send_beg),            csi_send_beg,            T02.S.csi_send_beg),
send_to_others      = ifelse(is.na(T02.S.csi_send_to_others),      csi_send_to_others,      T02.S.csi_send_to_others),
consume_stock       = ifelse(is.na(T02.S.csi_consume_stock),       csi_consume_stock,       T02.S.csi_consume_stock),
harvest_early       = ifelse(is.na(T02.S.csi_harvest_early),       csi_harvest_early,       T02.S.csi_harvest_early),
purchase_on_credit  = ifelse(is.na(T02.S.csi_purchase_on_credit),  csi_purchase_on_credit,  T02.S.csi_purchase_on_credit),
borrow_food         = ifelse(is.na(T02.S.csi_borrow_food),         csi_borrow_food,         T02.S.csi_borrow_food),
less_preferred      = ifelse(is.na(T02.S.csi_less_preferred),      csi_less_preferred,      T02.S.csi_less_preferred)
) %>%
mutate(hh_id = substr(unique_ind_id, 1,5)) %>%
dplyr::select(unique_ind_id, hh_id, site_code:last_col()) %>%
drop_na()
View(df3)
df4 <- df3 %>%
pivot_longer(!(unique_ind_id:time_point), names_to = "variable", values_to = "num.days") %>%
mutate(num.days = case_when(
num.days == "days_0" ~ 0,
num.days == "days_1" ~ 1,
num.days == "days_2" ~ 2,
num.days == "days_3" ~ 3,
num.days == "days_4" ~ 4,
num.days == "days_5" ~ 5,
num.days == "days_6" ~ 6,
num.days == "days_7" ~ 7))
#mean number of days point
df4 %>%
group_by(site_code, time_point, variable) %>%
summarize(mean = mean(num.days)) %>%
ggplot(aes(x = time_point, y = mean, color = variable)) +
geom_point() +
facet_grid(cols = vars(site_code), rows = vars(variable))
#% boxplot
df4 %>%
ggplot(aes(x = time_point, y = num.days, color = variable)) +
geom_boxplot() +
facet_grid(cols = vars(variable))
#%s
df4.p <- df4 %>%
group_by(variable, time_point, num.days) %>%
summarize(n = n()) %>% mutate(prop = n/sum(n))
df4.p %>%
ggplot(aes(x=time_point, y=prop, fill = num.days)) +
geom_bar(position = "stack", stat="identity") +
facet_wrap(vars(variable), nrow = 3) +
scale_fill_viridis_c(option = "mako", name = "Number of days\nper week", end = 0.95) +
xlab("Time Point") + ylab("Proportion of households") +
labs(title = "Food insecurity questionnaire response data",
subtitle = "Number of days within the last week that a household reports having to use the follow coping strategies due to a lack of sufficent food",
caption = "(see table below for definitions of the 15 indicators)") +
theme_bw() +
theme(panel.grid = element_blank(),
strip.background = element_rect(fill = "white"),
axis.text.x = element_text(angle = 90, hjust = 0.5, vjust = 0.5))
df4.long <- df4 %>% arrange(unique_ind_id, time_point) %>% filter(site_code == "N1")
df4.wide <- df4 %>% arrange(unique_ind_id, time_point) %>% filter(site_code == "N1") %>%
pivot_wider(names_from = variable, values_from = num.days)
View(df4.long)
View(df4.wide)
View(df4)
View(df4)
dfx <- df4 %>% group_by(unique_ind_id, time_point) %>% summarize(n = n())
View(dfx)
#Checking for duplicates
dfx <- df4 %>% group_by(unique_ind_id, time_point) %>% summarize(n = n()) %>% filter(n > median(n))
View(dfx)
# Data 1 ###################################################################################################
# Follow-up survey data (T02-T11)
dfA.i <- readxl::read_excel("/Users/blrice/Library/CloudStorage/Dropbox/Lab Projects/2020 Projects/CRS2020/1 DATA/DATA/DATA_QUESTIONNAIRE/T11_Commcare Data Downloads 20230428/2_fanadiadiana/1 Follow Up/MALARIA - FANADIADIANA - Follow Up Questionnaire (created 2023-04-29) 2023-04-29.xlsx")
dfy <- df4 %>% group_by(hh_id, time_point) %>% summarize(n = n())
View(dfy)
dfA.i <- readxl::read_excel("/Users/blrice/Library/CloudStorage/Dropbox/Lab Projects/2020 Projects/CRS2020/1 DATA/DATA/DATA_QUESTIONNAIRE/T11_Commcare Data Downloads 20230428/2_fanadiadiana/1 Follow Up/MALARIA - FANADIADIANA - Follow Up Questionnaire (created 2023-04-29) 2023-04-29.xlsx")
# Data 2 ###################################################################################################
# Baseline and new enrollee survey (T01 and some sporadic individuals at later time_points)
dfB.i <- readxl::read_excel("/Users/blrice/Library/CloudStorage/Dropbox/Lab Projects/2020 Projects/CRS2020/1 DATA/DATA/DATA_QUESTIONNAIRE/T11_Commcare Data Downloads 20230428/1_survey/2 individual/MALARIA - Surveys - v2_Individual (created 2023-04-29) 2023-04-29.xlsx")
